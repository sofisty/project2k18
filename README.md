# project2k18

Ανάπτυξη Λογισμικού για Πληροφοριακά Συστήματα
Project-Τμήμα 1ο
Readme

Compile:  make
Τρέχει ως ./rhj 
και μπορεί να πάρει ορίσματα 2 αρχεία για τους πίνακες R και S αντίστοιχα. Στη περίπτωση που δεν πάρει κανένα αρχείο, τότε δημιουργεί δυο τυχαία αρχεία πάνω στα οποία χτίζονται οι σχέσεις, ενώ εάν δοθεί μόνο ένα, βασίζεται πάνω σε αυτό η πρώτη σχέση και η δεύτερη δημιουργείται τυχαία αντίστοιχα.

Η εργασία αποτελείται από τα εξής παρακάτω αρχεία:
hash1.c/.h
hash2.c/.h
files.c/.h
results.c/.h
testing.c/.h και
main.c

Θα αναλύσουμε την χρησιμόητα του κάθε αρχείου και τη λειτουργία των συναρτήσεων του.

Hash1
Το αρχείο αυτό περιέχει όλες τις δομές και συναρτήσεις που χρειάζονται για να το πρώτο στάδιο ,αυτό της τμηματοποίησης, που υλοποιείται με κατακερματισμό σε κάδους. Η συνάρτηση κατακερματισμού hash1 που χρησιμοποιείται είναι τα n λιγότερα σημαντικά ψηφία του αριθμού. Περιέχει τις εξής συναρτήσεις: 
    • hash1_func : βρίσκει την hash value του δοθέντος κλειδιού
    • update_hist : Ενημερώνει το ιστόγραμμα με κάθε hash value που βρίσκει. Εάν υπάρχει ήδη αυξάνει το count της, αλλιώς προσθέτει την hash value στο ιστόγραμμα πάντα τηρώντας την ταξινόμηση της λίστας. Εάν το ιστόγραμμα είναι κενό, το δημιουργεί και το αρχικοποιέι με την δοθείσα hash value.
    • print_hist : εκτυπώνει όλο το ιστόγραμμα στην παρούσα κατάσταση του
    • free_hist : αποδεσμέυει την μνήμη που έχει δεσμευτεί για το ιστόγραμμα
    • create_psumlist : Δημιουργεί την psum_list από το δοθέν ιστόγραμμα. Αποθηκέυει ταξινομημένα τις hash values παίρνοντάς τες από το ιστόγραμμα, και έχοντας τα counts για κάθε hash value από το ιστόγραμμα υπολογίζει και αποθηκεύει τα offsets από τα οποία θα ξεκινάει η κάθε hash value αντίστοιχα στα reordered relations
    • print_psum : εκτυπώνει την psum_list
    • free_psum : αποδεσμεύει την μνήμη που έχει δεσμευτεί για την psum λίστα
    • search_Psum : υπολογίζει την hash value του δοθέντος key και ψάχνει στην psum_list το hash value και επιστρέφει το offset στο οποίο θα αποθηκευτεί το δοθέν key
    • reorder_R : ανάδιοργανώνει την δοθείσα relation έτσι ώστε να ταιριάζει απόλυτα με το ιστόγραμμα και την psum list και να λειτουργεί φυσιολογικά η πρώτη φάση του ευρετήριου. Επιστρέφει την νέα αναδιοργανωμένη σχέση
    • print_R : Εκτυπώνει όλη την δοθείσα σχέση


Hash2
Το αρχείο αυτό περιέχει όλες τις συναρτήσεις και δομές που χρειάζονται για τη δεύτερη φάση του ευρετηρίου που υλοποιείται με τις δομές bucket και chain. Η συνάρτηση κατακερματισμού hash2 που χρησιμοποιείται είναι το υπόλοιπο διαίρεσης του key με τον επόμενο πρώτο αριθμό από το πλήθος tuples που περιέχει ο κάδος που θα κατακερματιστεί.Περιέχει τις εξής συναρτήσεις: 
    • hash2_func : βρίσκει την hash value του δοθέντος κλειδιου
    • isPrime : ελέγχει αν ο δοθέν αριθμός είναι πρώτος ή οχι
    • next_prime : βρίσκει τον επόμενο πρώτο αριθμό μετά από τον αριθμό που έχει δοθεί ως όρισμα
    • bucket_chain : η συνάρτηση αυτή δημιουργεί τις δομές bucket και chain, και τα αρχικοποιεί με -1. Στην συνέχεια, ενημερώνει τις δομές σύμφωνα με τον κάδο στον οποίο γίνεται ο κατακερματισμός
    • free_bucket_chain : αποδεσμέυει την μνλημη που λεχει δεσμευτεί για τις δομές του ευρετηρίου, bucket και chain
    • buck_compare : συγκρίνει το μέγεθος των δύο κάδων που έχουν δοθεί ως ορίσαμτα για να αποφασίσει σε ποιό θα χτιστεί ευρετήριο bucket-chain. Επιστρέφει flag για τον κάδο που έχει τις λιγότερες tuples.
    • Serach match: Παίρνει ως όρισμα τους τρέχοντες δείκτες απο τα ιστογράμματα των R,S εξετάζει για αντιστοιχία των τιμών κατακερματισμού και τους ενημερώνει κατάλληλα για την επόμενη σύγκριση τιμών. Επιστρέφει ενα flag αν βρέθηκαν buckets με ίδια τιμή.
    • Join: Παίρνει ως όρισμα 2 buckets του R και του S που έχουν ίδια τιμή κατακερματισμού, καλέι τις συναρτησεις για την δημιουργία ευρετηρίου και έπειτα τις συναρτήσεις για την αναζήτηση και αποθήκευση των τελικών αποτελεσμάτων. Επιστρέφει τον δείκτη της result_list στη θέση που πρέπει να γίνει η επόμενη αποθήκευση αποτελέσματος.
    • final_hash : Δημιουργεί 2 δείκτες για τα ιστογράμματα των R,S και τους μετακινεί ώστε να βρεθεί αντιστοιχία των τιμων απο τον πρώτο κατακερματισμό, καλώντας την search match. Αν βρεθούν 2 buckets με κοινό hash value καλεί τις συναρτήσεις (join) ώστε να δημιουργηθεί το ευρετήριο, να βρεθούν και να αποθηκευτούν τα αποτελέμσατα. Επιστρέφει τη κεφαλή της λίστας με όλα τα αποτελέσματα. 



Results
    •  search_results: Παίνρει ως ορίσματα 2 buckets που  έχουν την ίδια τιμή από τον πρώτο κατακερματισμό, εκ των οπίων το ένα έχει το ευρετήριο. Σαρώνει το bucket του relation χωρίς ευρετήριο και για κάθε τιμή του, εφαρμόζει την hash2. Η τιμή που προκύπτει, είναι η θέση του bucket πίνακα στην οποία εξετάζεται αν υπάρχει κάποια εγγραφή. Αν υπάρχει και αντιστοιχία τιμών, αποθηκεύει τις εγγραφές των relations στην result_list. Στην συνέχεια, ακολουθεί τον πίνακα chain μέχρι να εξετάσει όλες τις τιμές του index που έχουν την hash2 value και να αποθηκεύσει όλα τα πιθανά αποτελέσματα.
    • store_results: Δημιουργεί την result list, μια λιστα απο result κόμβους. Κάθε κόμβος περιέχει 2 πίνακες απο tuples. Εκεί αποθηκεύονται παράλληλα tuple R με tuple S που έχουν ίδιες τιμές κλειδί. Επίσης, υπάρχει ένας μετρητής count σε κάθε κόμβο ώστε να  ξέρουμε πόσους συνδυασμούς tuples R-S έχουν αποθηκευτεί. Η συνάρτηση επιστρέφει έναν δείκτη στην θέση της λίστας που πρέπει να γίνει η επόμενη αποθήκευση.
    •  print_results: Σαρώνει την result_list και εκτυπώνει το σύνολο των αποτελεσμάτων, είναι σχολιασμένο ένα print που εκτυπώνει τις τιμές των tuples που έχουν αποθηκευτεί.
    • free_result_list: Αποδεσμεύει την μνήμη της result_list
    • RadixHashJoin: Η ζητούμενη συνάρτηση που παίρνει ως ορίσματα τα 2 relations και επιστρέφει τον πρώτο κόμβο της λίστας με τα αποτελέσματα. Για κάθε relation καλεί τις συναρτήσεις που περιγράφουμε παραπάνω ώστε να εκτελέσει την radix hash join.   

Files
Πρόκειται για το αρχείο που περιέχει όλες τις συναρτήσεις οι οποίες δημιουργούν τα data files, τα διαχειρίζονται και τα αποθηκεύουν στις αντίστοιχες δομές relation. Περιέχει τις εξής συναρτήσεις: 
    • generate_file : Δημιουργεί ένα αρχείο που μπορεί να έχει μεταξύ 1000 και 200000 εγγραφες σε μορφή tuples (row_id, key). Τα κλειδιά είναι τυχαίοι αριθμοί και ανήκουν στο εύρος 0-20000000. Επιστρέφει τον δείκτη στο συγκεκριμένο αρχείο.
    • count_lines : Παίρνει το αρχείο που δόθηκε ως όρισμα, το ανοίγει και το σαρώνει μέχρι να φτάσει στο τέλος του αρχείου. Επιστρέφει τον αριθμό γραμμών, και κατα συνέπεια και εγγραφών του αρχείου.
    • store_file : Αποθηκεύει στον δοσμένο πίνακα από tuples όλες τις εγγραφές του δοθλεντος αρχείου. Μόλις γεμίσει αυτός ο πίνακας, ουσιαστικά αντιπροσωπεύει το relation που θα χρησιμοποιηθεί στην συνέχεια για τη ζεύξη.
    • generate_file1 : Αποτελεί παραλλαγή της συνάρτησης generate_file και αποσκοπεί στο testing της καλής λειτουργικότητας του προγράμματος.Δημιουργεί ένα αρχείο που μπορεί να έχει μεταξύ 1000 και 10000 εγγραφών σε μορφή tuples (row_id, key), αλλά αυτή τη φορά τα κλειδιά είναι όλα κοινά και ίσα με τον αριθμό 1.
    • generate_file2 : Αποτελεί παραλλαγή της συνάρτησης generate_file και αποσκοπεί στο testing της καλής λειτουργικότητας του προγράμματος.Δημιουργεί ένα αρχείο που μπορεί να έχει μεταξύ 1000 και 200000 εγγραφών σε μορφή tuples (row_id, key), αλλά αυτή τη φορά τα κλειδιά είναι όλα μόνο περιττοί αριθμοί, οι οποίοι επιλέγονται τυχαία από ένα εύρος της τάξεως 0-2000000.
    • generate_file3 : Αποτελεί παραλλαγή της συνάρτησης generate_file και αποσκοπεί στο testing της καλής λειτουργικότητας του προγράμματος.Δημιουργεί ένα αρχείο που μπορεί να έχει μεταξύ 1000 και 200000 εγγραφών σε μορφή tuples (row_id, key), αλλά αυτή τη φορά τα κλειδιά είναι όλα μόνο άρτιοι αριθμοί, οι οποίοι επιλέγονται τυχαία από ένα εύρος της τάξεως 0-2000000.
    • generate_file4 : Αποτελεί παραλλαγή της συνάρτησης generate_file και αποσκοπεί στο testing της καλής λειτουργικότητας του προγράμματος.Δημιουργεί ένα αρχείο που μπορεί να έχει μεταξύ 1000 και 200000 εγγραφών σε μορφή tuples (row_id, key), αλλά αυτή τη φορά τα tuples είναι της μορφής (row_id, row_id).

Testing
Το αρχείο αυτό έχει ουσιαστικά τις 2 παρακάτω συναρτήσεις που αποσκοπούν στις δοκιμές σωστής λειτουργείας του προγράμματος:
    • testing : Σε αυτή τη συνάρτηση, ειναι σαν να τρέχει η main για 3 διαφορετικές περιπτώσεις συνδυασμών αρχείων. Στην πρώτη και τα 2 αρχεία έχουν ως κλειδιά μόνο την τιμη 1, με αποτέλεσμα η ζέυξη να δίνει ένα πολύ μεγάλο αριθμό ταιριαστών αποτελεσμάτων ίσο με ( χ x ψ), όπου χ ο αριθμός εγγραφών της πρώτης σχέσης και ψ ο αριθμός εγγραφών της δέυτερης σχέσης. Αυτή η δοκιμή είναι ίσως η πιο χρονοβόρα που εκτελείται. Στην δέυτερη περίπτωση, το ένα αρχείο περιέχει μόνο περιττά κλειδιά ενώ το δεύτερο αρχείο μόνο άρτια κλειδιά. Ως αναμενόμενο, αριθμός ταιριαστών αποτελεσμάτων όταν εκτελείται η ζεύξη των σχέσεων θα πρέπει να ισούται με 0. Και στην τρίτη περίπτωση, τα δύο αρχεία έχουν δημιουργηθεί ως εξής: Οι εγγραφές έχουν την μορφή (row_id, row_id) και στα δύο αρχεία, αλλά ο αριθμός εγγραφών διαφέρει, με αποτέλεσμα ένα μεγάλο κομμάτι των αρχείων να ταυτίζεται. Άρα ,εφόσον έχουμε για αυτά 1-1 αντισοιχεία εγγραφών , το αναμενόμενο αποτέλεσμα της ζεύξης των δύο σχέσεων είναι ο αριθμός εγγραφλων του μικρότερου από τα 2 αρχεία. Φυσικά, τα αποτελέσματα αυτών των δοκιμών αποθηκέυονται σε ξεχωριστά αρχεία. Όλες οι δοκιμές συνοδέυονται από εντολές assert, προκειμένου να ελέγχεται αν η κάθε δοκιμή ικανοποιεί την συνθήκη ομαλής λειτουργίας (δηλαδή των σωστό αριθμό αποτελεσμάτων). Εάν όχι, το πρόγραμμα τερματίζεται με μήνυμα από την assert.
    • store_test_res : Αποθηκεύει τα αποτελέσματα της ζεύξης κάθε δοκιμής σε ένα καινούργιο αρχείο, και επιστρέφει τον δέικτη σε αυτό.

Main
Αρχικά, γίνεται έλεγχος για το αν είναι σωστός ο αριθμός των ορισμάτων γραμμής εντολών. Εάν όχι το πρόγραμμα τερματίζει.Εάν είναι επιθυμητό από τον χρήστη, τρέχουν κάποια δοκιμαστικά αρχεία δεδομένων με την συνάρτηση testing. Στην συνέχεια δημιουργούνται (το πολύ) δύο αρχεία με εγγραφές της μορφής tuple (row_id, key) και με βάση αυτά χτίζονται οι δύο σχέσεις που θα υποστούν ζέυξη.Στη συνέχεια γίνονται οι απαραίτητοι κατακερματισμοί και χτίζεται το συνολικό ευρετήριο βάσει αυτών. Τέλος, γίνεται η πράξη Radix Hash Join, και τα αποτελέσματα της εκτυπώνονται στο terminal. Ό,τι μνήμη έχει δεσμευτεί κατα τη διάρκεια του τρεξίματος αποδεσμέυεται. Το πρόγραμμα τερματίζει.

